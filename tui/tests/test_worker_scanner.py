"""Tests for worker_scanner module."""

import pytest
from pathlib import Path
from unittest.mock import patch, MagicMock

from wiggum_tui.data.worker_scanner import (
    scan_workers,
    get_prd_status,
    get_worker_counts,
    get_running_worker_for_task,
    get_task_running_status,
    WORKER_PATTERN,
    is_process_running,
)
from wiggum_tui.data.models import Worker, WorkerStatus


class TestWorkerPattern:
    """Tests for the worker directory regex pattern."""

    def test_matches_valid_worker_names(self):
        valid_names = [
            "worker-TASK-001-1700000000",
            "worker-DEV-42-1234567890",
            "worker-TEST-1-9999999999",
            "worker-ABCDEFGHIJ-9999-1111111111",
        ]
        for name in valid_names:
            match = WORKER_PATTERN.match(name)
            assert match is not None, f"Should match: {name}"

    def test_extracts_task_id_and_timestamp(self):
        match = WORKER_PATTERN.match("worker-TASK-001-1700000000")
        assert match is not None
        task_id, timestamp = match.groups()
        assert task_id == "TASK-001"
        assert timestamp == "1700000000"

    def test_no_match_invalid_names(self):
        invalid_names = [
            "worker-TASK-001",  # Missing timestamp
            "TASK-001-1700000000",  # Missing worker- prefix
            "worker-A-1-1700000000",  # Prefix too short
            "worker-TASK-12345-1700000000",  # Number too long
        ]
        for name in invalid_names:
            assert WORKER_PATTERN.match(name) is None, f"Should not match: {name}"


class TestGetPrdStatus:
    """Tests for get_prd_status function."""

    def test_complete_prd(self, tmp_path: Path):
        prd = tmp_path / "prd.md"
        prd.write_text("# PRD\n- [x] Task 1\n- [x] Task 2\n")
        assert get_prd_status(prd) == "complete"

    def test_incomplete_prd(self, tmp_path: Path):
        prd = tmp_path / "prd.md"
        prd.write_text("# PRD\n- [x] Task 1\n- [ ] Task 2\n")
        assert get_prd_status(prd) == "incomplete"

    def test_failed_prd(self, tmp_path: Path):
        prd = tmp_path / "prd.md"
        prd.write_text("# PRD\n- [x] Task 1\n- [*] Task 2\n")
        assert get_prd_status(prd) == "failed"

    def test_failed_takes_precedence(self, tmp_path: Path):
        prd = tmp_path / "prd.md"
        prd.write_text("# PRD\n- [ ] Task 1\n- [*] Task 2\n")
        assert get_prd_status(prd) == "failed"

    def test_missing_file(self, tmp_path: Path):
        prd = tmp_path / "nonexistent.md"
        assert get_prd_status(prd) == "incomplete"

    def test_empty_prd(self, tmp_path: Path):
        prd = tmp_path / "prd.md"
        prd.write_text("")
        assert get_prd_status(prd) == "complete"


class TestScanWorkers:
    """Tests for scan_workers function."""

    def test_no_workers_directory(self, tmp_path: Path):
        ralph_dir = tmp_path / ".ralph"
        ralph_dir.mkdir()
        workers = scan_workers(ralph_dir)
        assert workers == []

    def test_empty_workers_directory(self, tmp_path: Path):
        ralph_dir = tmp_path / ".ralph"
        ralph_dir.mkdir()
        (ralph_dir / "workers").mkdir()
        workers = scan_workers(ralph_dir)
        assert workers == []

    def test_ignores_non_worker_directories(self, tmp_path: Path):
        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"
        workers_dir.mkdir(parents=True)

        # Create non-worker directories
        (workers_dir / "somefile.txt").write_text("ignored")
        (workers_dir / "random-dir").mkdir()
        (workers_dir / "worker-invalid").mkdir()  # Invalid format

        workers = scan_workers(ralph_dir)
        assert workers == []

    @patch("wiggum_tui.data.worker_scanner.is_process_running")
    @patch("wiggum_tui.data.worker_scanner.is_worker_process")
    def test_scans_worker_directory(
        self, mock_is_worker, mock_is_running, tmp_path: Path
    ):
        mock_is_running.return_value = False
        mock_is_worker.return_value = False

        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"
        worker_dir = workers_dir / "worker-TASK-001-1700000000"
        worker_dir.mkdir(parents=True)

        # Create required files
        (worker_dir / "prd.md").write_text("- [x] Done")
        (worker_dir / "worker.log").write_text("log content")

        workers = scan_workers(ralph_dir)

        assert len(workers) == 1
        assert workers[0].id == "worker-TASK-001-1700000000"
        assert workers[0].task_id == "TASK-001"
        assert workers[0].status == WorkerStatus.COMPLETED

    @patch("wiggum_tui.data.worker_scanner.is_process_running")
    @patch("wiggum_tui.data.worker_scanner.is_worker_process")
    def test_detects_running_worker(
        self, mock_is_worker, mock_is_running, tmp_path: Path
    ):
        mock_is_running.return_value = True
        mock_is_worker.return_value = True

        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"
        worker_dir = workers_dir / "worker-TASK-001-1700000000"
        worker_dir.mkdir(parents=True)

        # Create PID file
        (worker_dir / "agent.pid").write_text("12345")
        (worker_dir / "prd.md").write_text("- [ ] Not done")

        workers = scan_workers(ralph_dir)

        assert len(workers) == 1
        assert workers[0].status == WorkerStatus.RUNNING
        assert workers[0].pid == 12345

    @patch("wiggum_tui.data.worker_scanner.is_process_running")
    @patch("wiggum_tui.data.worker_scanner.is_worker_process")
    def test_detects_failed_worker(
        self, mock_is_worker, mock_is_running, tmp_path: Path
    ):
        mock_is_running.return_value = False
        mock_is_worker.return_value = False

        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"
        worker_dir = workers_dir / "worker-TASK-001-1700000000"
        worker_dir.mkdir(parents=True)

        (worker_dir / "prd.md").write_text("- [*] Failed task")

        workers = scan_workers(ralph_dir)

        assert len(workers) == 1
        assert workers[0].status == WorkerStatus.FAILED

    @patch("wiggum_tui.data.worker_scanner.is_process_running")
    @patch("wiggum_tui.data.worker_scanner.is_worker_process")
    def test_reads_pr_url(self, mock_is_worker, mock_is_running, tmp_path: Path):
        mock_is_running.return_value = False
        mock_is_worker.return_value = False

        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"
        worker_dir = workers_dir / "worker-TASK-001-1700000000"
        worker_dir.mkdir(parents=True)

        (worker_dir / "prd.md").write_text("- [x] Done")
        (worker_dir / "pr_url.txt").write_text("https://github.com/example/pr/123")

        workers = scan_workers(ralph_dir)

        assert len(workers) == 1
        assert workers[0].pr_url == "https://github.com/example/pr/123"

    @patch("wiggum_tui.data.worker_scanner.is_process_running")
    @patch("wiggum_tui.data.worker_scanner.is_worker_process")
    def test_sorts_by_timestamp_descending(
        self, mock_is_worker, mock_is_running, tmp_path: Path
    ):
        mock_is_running.return_value = False
        mock_is_worker.return_value = False

        ralph_dir = tmp_path / ".ralph"
        workers_dir = ralph_dir / "workers"

        # Create workers with different mtimes
        for i, name in enumerate(
            [
                "worker-TASK-001-1700000001",
                "worker-TASK-002-1700000002",
                "worker-TASK-003-1700000003",
            ]
        ):
            worker_dir = workers_dir / name
            worker_dir.mkdir(parents=True)
            (worker_dir / "prd.md").write_text("- [x] Done")

        workers = scan_workers(ralph_dir)

        assert len(workers) == 3
        # Should be sorted by mtime (newest first), but since we just created them
        # the order depends on filesystem timing. Just verify count.

    def test_fixture_ralph_with_workers(self, ralph_with_workers: Path):
        # This test uses the fixture which has a worker directory
        # but no running process, so we need to mock the process checks
        with patch(
            "wiggum_tui.data.worker_scanner.is_process_running"
        ) as mock_running, patch(
            "wiggum_tui.data.worker_scanner.is_worker_process"
        ) as mock_worker:
            mock_running.return_value = False
            mock_worker.return_value = False

            workers = scan_workers(ralph_with_workers)

            assert len(workers) >= 1
            # Find the TEST-001 worker
            test_worker = next(
                (w for w in workers if w.task_id == "TEST-001"), None
            )
            assert test_worker is not None


class TestGetWorkerCounts:
    """Tests for get_worker_counts function."""

    def test_empty_list(self):
        result = get_worker_counts([])
        assert result["total"] == 0
        assert result["running"] == 0
        assert result["completed"] == 0

    def test_counts_correctly(self):
        workers = [
            Worker(
                id="w1",
                task_id="T-1",
                timestamp=1,
                pid=None,
                status=WorkerStatus.RUNNING,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
            Worker(
                id="w2",
                task_id="T-2",
                timestamp=2,
                pid=None,
                status=WorkerStatus.RUNNING,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
            Worker(
                id="w3",
                task_id="T-3",
                timestamp=3,
                pid=None,
                status=WorkerStatus.COMPLETED,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
            Worker(
                id="w4",
                task_id="T-4",
                timestamp=4,
                pid=None,
                status=WorkerStatus.FAILED,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
        ]
        result = get_worker_counts(workers)

        assert result["total"] == 4
        assert result["running"] == 2
        assert result["completed"] == 1
        assert result["failed"] == 1
        assert result["stopped"] == 0


class TestGetRunningWorkerForTask:
    """Tests for get_running_worker_for_task function."""

    @patch("wiggum_tui.data.worker_scanner.scan_workers")
    def test_finds_running_worker(self, mock_scan):
        mock_scan.return_value = [
            Worker(
                id="w1",
                task_id="TASK-001",
                timestamp=1,
                pid=123,
                status=WorkerStatus.RUNNING,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
        ]
        result = get_running_worker_for_task(Path("/fake"), "TASK-001")
        assert result is not None
        assert result.task_id == "TASK-001"

    @patch("wiggum_tui.data.worker_scanner.scan_workers")
    def test_returns_none_if_not_running(self, mock_scan):
        mock_scan.return_value = [
            Worker(
                id="w1",
                task_id="TASK-001",
                timestamp=1,
                pid=None,
                status=WorkerStatus.COMPLETED,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
        ]
        result = get_running_worker_for_task(Path("/fake"), "TASK-001")
        assert result is None

    @patch("wiggum_tui.data.worker_scanner.scan_workers")
    def test_returns_none_if_not_found(self, mock_scan):
        mock_scan.return_value = []
        result = get_running_worker_for_task(Path("/fake"), "TASK-001")
        assert result is None


class TestGetTaskRunningStatus:
    """Tests for get_task_running_status function."""

    @patch("wiggum_tui.data.worker_scanner.scan_workers")
    def test_returns_status_for_multiple_tasks(self, mock_scan):
        mock_scan.return_value = [
            Worker(
                id="w1",
                task_id="TASK-001",
                timestamp=1000,
                pid=123,
                status=WorkerStatus.RUNNING,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
            Worker(
                id="w2",
                task_id="TASK-002",
                timestamp=2000,
                pid=None,
                status=WorkerStatus.COMPLETED,
                prd_path="",
                log_path="",
                workspace_path="",
            ),
        ]
        result = get_task_running_status(
            Path("/fake"), ["TASK-001", "TASK-002", "TASK-003"]
        )

        assert result["TASK-001"] == (True, 1000)
        assert result["TASK-002"] == (False, None)
        assert result["TASK-003"] == (False, None)
